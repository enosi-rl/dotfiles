# zsh Profiling
# zmodload zsh/zprof

# Only add to PATH if $HOME/bin is not already present
if [[ ":$PATH:" != *":$HOME/bin:"* ]]; then
  export PATH="$HOME/bin:$HOME/.local/bin:$PATH"
fi

##
## Mise (must be first)
##
eval "$(mise activate zsh)"

##
## 1Password ssh-agent
##
if [[ ! -L "$HOME/.1password/agent.sock" ]]; then
  mkdir -p ~/.1password && ln -s ~/Library/Group\ Containers/2BUA8C4S2C.com.1password/t/agent.sock ~/.1password/agent.sock
fi

export SSH_AUTH_SOCK=~/.1password/agent.sock

##
## Auto-complete (only check once a day)
##
autoload bashcompinit && bashcompinit
autoload -Uz compinit
if [ $(date +'%j') != $(stat -f '%Sm' -t '%j' ~/.zcompdump) ]; then
  compinit
else
  compinit -C
fi

##
## Difft
##
export DFT_COLOR=always

##
## Docker
##
export DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}
export DOCKER_DEFAULT_PLATFORM=linux/amd64

# Docker plugins - see https://docs.docker.com/compose/install/linux/#install-the-plugin-manually

##
## Graphite
##
#compdef gt
###-begin-gt-completions-###
#
# yargs command completion script
#
# Installation: gt completion >> ~/.zshrc
#    or gt completion >> ~/.zprofile on OSX.
#
_gt_yargs_completions()
{
  local reply
  local si=$IFS
  IFS=$'
' reply=($(COMP_CWORD="$((CURRENT-1))" COMP_LINE="$BUFFER" COMP_POINT="$CURSOR" gt --get-yargs-completions "${words[@]}"))
  IFS=$si
  _describe 'values' reply
}
compdef _gt_yargs_completions gt
###-end-gt-completions-###

##
## Hermit
##
# Generated by Hermit; START; DO NOT EDIT.
HERMIT_ROOT_BIN="${HERMIT_ROOT_BIN:-"$HOME/bin/hermit"}"
eval "$(test -x $HERMIT_ROOT_BIN && $HERMIT_ROOT_BIN shell-hooks --print --zsh)"
# Generated by Hermit; END; DO NOT EDIT.

##
## jujitsu - https://jj-vcs.github.io/jj/latest/install-and-setup/#standard_1
##
# source <(jj util completion zsh)

##
## Neovim
##
# Needed for neovim plugins which have homebrew hard-coded
SQLITE_LIB_DIR=/opt/homebrew/opt/sqlite/lib
SQLITE_LIB="$SQLITE_LIB_DIR"/libsqlite3.dylib
if [[ ! -f "$SQLITE_LIB" ]]; then
  echo "Setting up sqlite lib for neovim - enter sudo password"
  sudo mkdir -p "$SQLITE_LIB_DIR"
  sudo ln -s $(mise where sqlite)/lib/libsqlite3.dylib "$SQLITE_LIB"
fi

##
## ripgrep
##
export RIPGREP_CONFIG_PATH=~/.ripgreprc

##
## Starship
##
eval "$(starship init zsh)"

##
## Wezterm
##
source ~/bin/wezterm-shell-integration.sh

##
## Shell
##

# Vi mode
set -o vi

# Use zed as the editor
export VISUAL="zed --wait"
export EDITOR="$VISUAL"

##
## History
##
HISTFILE=$HOME/.zsh_history
HISTSIZE=10000000
SAVEHIST=10000000

# Don't record certain commands:
HISTORY_IGNORE="(ls|cd|pwd|exit)*"

# Immediately append to history file:
setopt INC_APPEND_HISTORY

# Record timestamp in history:
setopt EXTENDED_HISTORY

# Expire duplicate entries first when trimming history:
setopt HIST_EXPIRE_DUPS_FIRST

# Do not display a line previously found:
setopt HIST_FIND_NO_DUPS

# Delete old recorded entry if new entry is a duplicate:
setopt HIST_IGNORE_ALL_DUPS

# Dont record an entry that was just recorded again:
setopt HIST_IGNORE_DUPS

# Dont record an entry starting with a space:
setopt HIST_IGNORE_SPACE

# Remove superfluous blanks from each command line being added to the history.
setopt HIST_REDUCE_BLANKS

# Dont write duplicate entries in the history file:
setopt HIST_SAVE_NO_DUPS

# Share history between all sessions:
setopt SHARE_HISTORY

# Execute commands using history (e.g.: using !$) immediately:
unsetopt HIST_VERIFY

##
## Antidote - package manager
##
# Set the name of the static .zsh plugins file antidote will generate.
zsh_plugins=${ZDOTDIR:-~}/.zsh_plugins.zsh

# Ensure you have a .zsh_plugins.txt file where you can add plugins.
[[ -f ${zsh_plugins:r}.txt ]] || touch ${zsh_plugins:r}.txt

# Lazy-load antidote.
fpath+=(${ZDOTDIR:-~}/.antidote)
autoload -Uz $fpath[-1]/antidote

# Generate static file in a subshell when .zsh_plugins.txt is updated.
if [[ ! $zsh_plugins -nt ${zsh_plugins:r}.txt ]]; then
  (antidote bundle <${zsh_plugins:r}.txt >|$zsh_plugins)
fi

# Source your static plugins file.
source $zsh_plugins

##
## zsh-vim-mode - https://github.com/softmoth/zsh-vim-mode
##
MODE_CURSOR_VIINS="#ffffff blinking bar"
MODE_CURSOR_REPLACE="$MODE_CURSOR_VIINS #ff0000"
MODE_CURSOR_VICMD="white block"
MODE_CURSOR_SEARCH="#ff00ff steady underline"
MODE_CURSOR_VISUAL="$MODE_CURSOR_VICMD steady bar"
MODE_CURSOR_VLINE="$MODE_CURSOR_VISUAL #00ffff"

##
## Aliases
##
alias ..='cd ..'
alias 2..='cd ../..'
alias 3..='cd ../../..'
alias 4..='cd ../../../..'
alias 5..='cd ../../../../..'
alias ag='auggie --model GPT-5 --rules ~/augment-guidelines'
alias agc='auggie --model GPT-5 --rules ~/augment-guidelines --continue'
alias cdc='cd ~/code'
alias cdcc='cd ~/code/common/main.common'
alias cdcea='cd ~/code/esna-exempt-supply-aggregator/main.esas/'
alias cdcen='cd ~/code/esna-settlements-notifier/main.esna.notifier/'
alias cdch='cd ~/code/historian/main.historian/'
alias cdcs='cd ~/code/syndesi/main.syndesi/'
alias cdcte='cd ~/code/trade-engine/main.trade.engine/'
alias cdctre='cd ~/code/trade-register/main.trade.register/'
alias cdctru='cd ~/code/trade-rules/main.trade.rules/'
alias cdi='cd ~/infra'
alias cdie='cd ~/infra/infra-enosi-evolve-energy/staging.evolve.infra'
alias cdiei='cd ~/infra/infra-enosi-evolve-energy-integration/prod.evolve.integration'
alias cdp='cd ~/proj'
alias cdpe='cd ~/proj/evolve-reconcile/'
alias cp='cp -i'
alias docker-stop-all='docker container stop $(docker container list -q) && docker container prune -f'
alias ga='git add'
alias gc='git commit'
alias gd='git diff --color-words'
alias gdtl='git difftool'
alias gdtlc='git difftool --cached'
alias gl='git log'
alias glr='git lr'
alias gp='git pull'
alias gprev='git switch -'
alias gr='git restore'
alias grs='git restore --staged'
alias gs='git status'
alias gsh='git show'
alias gshn='git show --pretty="" --name-only'
alias gtc='gt create'
alias gtm='gt modify'
alias gts='gt sync'
alias gtsup='gt submit --cli --update-only'
alias gtspb='gt submit --cli --publish --stack'
alias ij='/Applications/IntelliJ\ IDEA.app/Contents/MacOS/idea'
alias ll='ls -alF'
alias mv='mv -i'
alias rm='rm -i'
alias vim='nvim'
alias z='zed'
alias zd='zed --diff'

# ceedee dot dot dot
alias -g ...='../..'
alias -g ....='../../..'
alias -g .....='../../../..'

## Global - see https://justingarrison.com/blog/2023-06-05-zsh-global-aliases/
alias -g G='| grep'
alias -g H='| head -R'
alias -g L='| less -R'
alias -g M='| mlr cat'
alias -g R='| rg'

# Originally from https://apple.stackexchange.com/questions/92640/how-do-i-prevent-the-permissions-denied-message-from-being-displayed-when-i-do-a
find() {
  LC_ALL=C command find "$@" 2>&1 | grep -v -e 'Permission denied' -e 'Operation not permitted'
}

# various sources reslting from https://news.ycombinator.com/item?id=45670052

# make a directory and cds inside.
mkcd() {
  mkdir -p -- "$1" &&
  cd -- "$1"
}

# changes to a temporary directory.aka sandbox
sbox () {
  cd "$(mktemp -d)"
  chmod -R 0700 .
  if [[ $# -eq 1 ]]; then
    \mkdir -p "$1"
    cd "$1"
    chmod -R 0700 .
  fi
}

##
## Enosi
##
export ENOSI_COMMON_DIR=~/code/common
export GOPRIVATE=github.com/enosi

##
## fzf (setup last)
##
# Set up fzf key bindings and fuzzy completion
source <(fzf --zsh)
# [ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# [ -f ~/bin/fzf-git.sh ] && source ~/bin/fzf-git.sh

# Show in reverse order
export FZF_DEFAULT_OPTS='--height 33% --layout=reverse'

# Add '?' to show preview window for long commands
export FZF_CTRL_R_OPTS="--preview 'echo {}' --preview-window down:3:hidden:wrap --bind '?:toggle-preview'"

# Use 'ctrl-x ctrl-r' to run command immediately
# Doesn't work :-(
# fzf-history-widget-accept() {
#   fzf-history-widget
#   zle accept-line
# }
# zle     -N     fzf-history-widget-accept
# bindkey '^X^R' fzf-history-widget-accept

# gco() {
#   _fzf_git_each_ref --no-multi | xargs git checkout
# }

# zsh Profiling
# zprof
#

# Homebrew (for postgres via mise)
export PKG_CONFIG_PATH="/opt/homebrew/bin/pkg-config:$(brew --prefix icu4c)/lib/pkgconfig:$(brew --prefix curl)/lib/pkgconfig:$(brew --prefix zlib)/lib/pkgconfig"

##
##Q Ruby (brew)
##
export PATH="/opt/homebrew/opt/ruby/bin:$PATH"

# For compilers to find ruby@3.3 you may need to set:
export LDFLAGS="-L/opt/homebrew/opt/ruby/lib"
export CPPFLAGS="-I/opt/homebrew/opt/ruby/include"

# For pkg-config to find ruby@3.3 you may need to set:
export PKG_CONFIG_PATH="/opt/homebrew/opt/ruby/lib/pkgconfig"

# Added by LM Studio CLI (lms)
export PATH="$PATH:/Users/robert/.lmstudio/bin"
# End of LM Studio CLI section
